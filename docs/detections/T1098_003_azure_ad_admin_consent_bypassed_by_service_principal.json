{
  "schema_version": "1.2",
  "file_name": "T1098_003_azure_ad_admin_consent_bypassed_by_service_principal.json",
  "Roles": [
    {
      "Role": "Requestor",
      "Name": "",
      "Title": ""
    },
    {
      "Role": "Business Owner",
      "Name": "",
      "Title": ""
    },
    {
      "Role": "Technical Owner",
      "Name": "",
      "Title": ""
    }
  ],
  "Description": "The following analytic identifies instances where a service principal in Azure Active Directory assigns app roles without standard admin consent. It uses Entra ID logs from the `azure_monitor_aad` data source, focusing on the \"Add app role assignment to service principal\" operation. This detection is significant as it highlights potential bypasses of critical administrative consent processes, which could lead to unauthorized privileges being granted. If confirmed malicious, this activity could allow attackers to exploit automation to assign sensitive permissions without proper oversight, potentially compromising the security of the Azure AD environment.",
  "Assumptions": "Assumptions:\n- Azure AD audit logs are being ingested via EventHub\n- Splunk Add-on for Microsoft Cloud Services is installed\n- Service principals are configured in the environment\n\nPotential Impact:\n- Unauthorized privilege escalation via service principals\n- Bypass of administrative consent processes\n- Compromised Azure AD security posture",
  "origin": "custom",
  "Detection Name": "Azure AD Admin Consent Bypassed by Service Principal",
  "Objective": "Detect and alert when service principals assign app roles without going through standard admin consent workflows, which may indicate privilege escalation attempts.",
  "Severity/Priority": "Medium",
  "Analyst Next Steps": "1. Identify the service principal (src_user) that performed the role assignment\n2. Review the permissions granted (roleValue, roleDescription)\n3. Verify if this service principal should have the ability to assign roles\n4. Check if the target user legitimately needs these permissions\n5. Review the service principal's activity history for suspicious patterns",
  "Blind_Spots_False_Positives": "Blind Spots:\n- Role assignments made through methods not captured in audit logs\n- Service principals with legitimate automation needs\n\nFalse Positives:\n- Service Principals are sometimes configured to legitimately bypass the consent process for purposes of automation. Filter as needed.",
  "Required_Data_Sources": "Azure Active Directory AuditLogs",
  "First Created": "2025-05-02T00:00:00.000Z",
  "Last Modified": "2026-01-22T00:00:00.000Z",
  "Search String": "`azure_monitor_aad` (operationName=\"Add app role assignment to service principal\" OR operationName=\"Add member to role*\") src_user_type=servicePrincipal | rename properties.* as * | eval roleId = mvindex('targetResources{}.modifiedProperties{}.newValue',0) | eval roleValue = mvindex('targetResources{}.modifiedProperties{}.newValue',1) | eval roleDescription = mvindex('targetResources{}.modifiedProperties{}.newValue',2) | eval user_id = mvindex('targetResources{}.id', 0), user=coalesce(user,mvindex('targetResources{}.displayName',0)) | rename initiatedBy.app.displayName as src_user, userAgent as user_agent | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product src_user user_id roleId roleValue roleDescription user_agent signature | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `azure_ad_admin_consent_bypassed_by_service_principal_filter`",
  "Splunk_App_Context": "search",
  "Search_Duration": "-15m",
  "Cron Schedule": "*/15 * * * *",
  "Schedule Window": "5",
  "Schedule Priority": "default",
  "Trigger Condition": "Number of results is greater than 0",
  "Throttling": {
    "enabled": 1,
    "fields": "user,src_user",
    "period": "1h"
  },
  "Risk": [
    {
      "risk_object_field": "user",
      "risk_object_type": "user",
      "risk_score": 54
    },
    {
      "risk_object_field": "src_user",
      "risk_object_type": "user",
      "risk_score": 54
    }
  ],
  "Notable Title": "Azure AD Admin Consent Bypassed by Service Principal $src_user$",
  "Notable Description": "Service principal $src_user$ bypassed the admin consent process and granted permissions to $user$",
  "Security Domain": "identity",
  "Drilldown Name (Legacy)": "View Events Associated to this Notable on Identity",
  "Drilldown Search (Legacy)": "`azure_monitor_aad` operationName=\"Add app role assignment to service principal\" dest=\"$dest$\" | table _time src_user user roleValue roleDescription",
  "Drilldown Earliest Offset (Legacy)": "2592000",
  "Drilldown Latest Offset (Legacy)": "86400",
  "Mitre ID": [
    "T1098.003"
  ],
  "Drilldown Name 1": "View the detection results for - \"$dest$\"",
  "Drilldown Search 1": "%original_detection_search% | search  dest = \"$dest$\"",
  "Drilldown Earliest 1": "$info_min_time$",
  "Drilldown Latest 1": "$info_max_time$",
  "Drilldown Name 2": "View risk events for the last 7 days for - \"$dest$\"",
  "Drilldown Search 2": "| from datamodel Risk.All_Risk | search normalized_risk_object IN (\"$dest$\") starthoursago=168  | stats count min(_time) as firstTime max(_time) as lastTime values(search_name) as \"Search Name\" values(risk_message) as \"Risk Message\" values(analyticstories) as \"Analytic Stories\" values(annotations._all) as \"Annotations\" values(annotations.mitre_attack.mitre_tactic) as \"ATT&CK Tactics\" by normalized_risk_object | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`",
  "Drilldown Earliest 2": "$info_min_time$",
  "Drilldown Latest 2": "$info_max_time$",
  "Drilldown Name 3": "",
  "Drilldown Search 3": "",
  "Drilldown Earliest 3": null,
  "Drilldown Latest 3": null,
  "Drilldown Name 4": "",
  "Drilldown Search 4": "",
  "Drilldown Earliest 4": null,
  "Drilldown Latest 4": null,
  "Drilldown Name 5": "",
  "Drilldown Search 5": "",
  "Drilldown Earliest 5": null,
  "Drilldown Latest 5": null,
  "Drilldown Name 6": "",
  "Drilldown Search 6": "",
  "Drilldown Earliest 6": null,
  "Drilldown Latest 6": null,
  "Drilldown Name 7": "",
  "Drilldown Search 7": "",
  "Drilldown Earliest 7": null,
  "Drilldown Latest 7": null,
  "Drilldown Name 8": "",
  "Drilldown Search 8": "",
  "Drilldown Earliest 8": null,
  "Drilldown Latest 8": null,
  "Drilldown Name 9": "",
  "Drilldown Search 9": "",
  "Drilldown Earliest 9": null,
  "Drilldown Latest 9": null,
  "Drilldown Name 10": "",
  "Drilldown Search 10": "",
  "Drilldown Earliest 10": null,
  "Drilldown Latest 10": null,
  "Drilldown Name 11": "",
  "Drilldown Search 11": "",
  "Drilldown Earliest 11": null,
  "Drilldown Latest 11": null,
  "Drilldown Name 12": "",
  "Drilldown Search 12": "",
  "Drilldown Earliest 12": null,
  "Drilldown Latest 12": null,
  "Drilldown Name 13": "",
  "Drilldown Search 13": "",
  "Drilldown Earliest 13": null,
  "Drilldown Latest 13": null,
  "Drilldown Name 14": "",
  "Drilldown Search 14": "",
  "Drilldown Earliest 14": null,
  "Drilldown Latest 14": null,
  "Drilldown Name 15": "",
  "Drilldown Search 15": "",
  "Drilldown Earliest 15": null,
  "Drilldown Latest 15": null,
  "Proposed Test Plan": ""
}