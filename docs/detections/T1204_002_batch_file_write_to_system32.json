{
  "schema_version": "1.2",
  "file_name": "T1204_002_batch_file_write_to_system32.json",
  "Roles": [
    {
      "Role": "Requestor",
      "Name": "",
      "Title": ""
    },
    {
      "Role": "Business Owner",
      "Name": "",
      "Title": ""
    },
    {
      "Role": "Technical Owner",
      "Name": "",
      "Title": ""
    }
  ],
  "Description": "The following analytic detects the creation of a batch file (.bat) within the Windows system directory tree, specifically in the System32 or SysWOW64 folders. It leverages data from the Endpoint datamodel, focusing on process and filesystem events to identify this behavior. This activity is significant because writing batch files to system directories can be indicative of malicious intent, such as persistence mechanisms or system manipulation. If confirmed malicious, this could allow an attacker to execute arbitrary commands with elevated privileges, potentially compromising the entire system.",
  "Assumptions": "Assumptions:\n- Sysmon EventID 11 is enabled for file creation monitoring\n- Endpoint datamodel is properly configured\n- File system events are being ingested into Splunk\n\nPotential Impact:\n- Persistence mechanism establishment\n- Arbitrary command execution with elevated privileges\n- System manipulation",
  "origin": "custom",
  "Detection Name": "Batch File Write to System32",
  "Objective": "Detect and alert on the creation of batch files in Windows system directories, which may indicate malicious activity or persistence mechanisms.",
  "Severity/Priority": "High",
  "Analyst Next Steps": "1. Confirm the path of the batch file identified by the search\n2. Review the contents of the batch file if possible\n3. Identify the process that created the file\n4. Check if this is legitimate administrative activity\n5. Investigate the user account associated with the file creation",
  "Blind_Spots_False_Positives": "Blind Spots:\n- Batch files created in other system directories\n- Script files with different extensions (.cmd, .ps1)\n\nFalse Positives:\n- Batch file paths containing the string \"system32\" but not the actual Windows system directory\n- Administrator copying a legitimate batch file in this directory tree",
  "Required_Data_Sources": "Sysmon EventID 11",
  "First Created": "2025-05-02T00:00:00.000Z",
  "Last Modified": "2026-01-22T00:00:00.000Z",
  "Search String": "| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.file_path IN (\"*\\\\system32\\\\*\",\"*\\\\syswow64\\\\*\") Filesystem.file_name=\"*.bat\" by Filesystem.action Filesystem.dest Filesystem.file_access_time Filesystem.file_create_time Filesystem.file_hash Filesystem.file_modify_time Filesystem.file_name Filesystem.file_path Filesystem.file_acl Filesystem.file_size Filesystem.process_guid Filesystem.process_id Filesystem.user Filesystem.vendor_product | `drop_dm_object_name(Filesystem)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `batch_file_write_to_system32_filter`",
  "Splunk_App_Context": "search",
  "Search_Duration": "-15m",
  "Cron Schedule": "*/15 * * * *",
  "Schedule Window": "5",
  "Schedule Priority": "default",
  "Trigger Condition": "Number of results is greater than 0",
  "Throttling": {
    "enabled": 1,
    "fields": "dest,file_name,user",
    "period": "1h"
  },
  "Risk": [
    {
      "risk_object_field": "user",
      "risk_object_type": "user",
      "risk_score": 63
    },
    {
      "risk_object_field": "dest",
      "risk_object_type": "system",
      "risk_score": 63
    }
  ],
  "Notable Title": "Batch File Written to System32 on $dest$",
  "Notable Description": "A file - $file_name$ was written to system32 has occurred on endpoint $dest$ by user $user$.",
  "Security Domain": "endpoint",
  "Drilldown Name (Legacy)": "View Events Associated to this Notable on Endpoint",
  "Drilldown Search (Legacy)": "| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem WHERE Filesystem.dest=\"$dest$\" Filesystem.file_path=\"*system32*\" by Filesystem.file_name Filesystem.file_path Filesystem.user | `drop_dm_object_name(Filesystem)`",
  "Drilldown Earliest Offset (Legacy)": "2592000",
  "Drilldown Latest Offset (Legacy)": "86400",
  "Mitre ID": [
    "T1204.002"
  ],
  "Drilldown Name 1": "View the detection results for - \"$user$\" and \"$dest$\"",
  "Drilldown Search 1": "%original_detection_search% | search  user = \"$user$\" dest = \"$dest$\"",
  "Drilldown Earliest 1": "$info_min_time$",
  "Drilldown Latest 1": "$info_max_time$",
  "Drilldown Name 2": "View risk events for the last 7 days for - \"$user$\" and \"$dest$\"",
  "Drilldown Search 2": "| from datamodel Risk.All_Risk | search normalized_risk_object IN (\"$user$\", \"$dest$\") starthoursago=168  | stats count min(_time) as firstTime max(_time) as lastTime values(search_name) as \"Search Name\" values(risk_message) as \"Risk Message\" values(analyticstories) as \"Analytic Stories\" values(annotations._all) as \"Annotations\" values(annotations.mitre_attack.mitre_tactic) as \"ATT&CK Tactics\" by normalized_risk_object | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`",
  "Drilldown Earliest 2": "$info_min_time$",
  "Drilldown Latest 2": "$info_max_time$",
  "Drilldown Name 3": "",
  "Drilldown Search 3": "",
  "Drilldown Earliest 3": null,
  "Drilldown Latest 3": null,
  "Drilldown Name 4": "",
  "Drilldown Search 4": "",
  "Drilldown Earliest 4": null,
  "Drilldown Latest 4": null,
  "Drilldown Name 5": "",
  "Drilldown Search 5": "",
  "Drilldown Earliest 5": null,
  "Drilldown Latest 5": null,
  "Drilldown Name 6": "",
  "Drilldown Search 6": "",
  "Drilldown Earliest 6": null,
  "Drilldown Latest 6": null,
  "Drilldown Name 7": "",
  "Drilldown Search 7": "",
  "Drilldown Earliest 7": null,
  "Drilldown Latest 7": null,
  "Drilldown Name 8": "",
  "Drilldown Search 8": "",
  "Drilldown Earliest 8": null,
  "Drilldown Latest 8": null,
  "Drilldown Name 9": "",
  "Drilldown Search 9": "",
  "Drilldown Earliest 9": null,
  "Drilldown Latest 9": null,
  "Drilldown Name 10": "",
  "Drilldown Search 10": "",
  "Drilldown Earliest 10": null,
  "Drilldown Latest 10": null,
  "Drilldown Name 11": "",
  "Drilldown Search 11": "",
  "Drilldown Earliest 11": null,
  "Drilldown Latest 11": null,
  "Drilldown Name 12": "",
  "Drilldown Search 12": "",
  "Drilldown Earliest 12": null,
  "Drilldown Latest 12": null,
  "Drilldown Name 13": "",
  "Drilldown Search 13": "",
  "Drilldown Earliest 13": null,
  "Drilldown Latest 13": null,
  "Drilldown Name 14": "",
  "Drilldown Search 14": "",
  "Drilldown Earliest 14": null,
  "Drilldown Latest 14": null,
  "Drilldown Name 15": "",
  "Drilldown Search 15": "",
  "Drilldown Earliest 15": null,
  "Drilldown Latest 15": null,
  "Proposed Test Plan": ""
}