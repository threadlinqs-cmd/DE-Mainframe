{
  "schema_version": "1.2",
  "file_name": "T1078_004_azure_ad_authentication_failed_during_mfa_challenge.json",
  "Roles": [
    {
      "Role": "Requestor",
      "Name": "",
      "Title": ""
    },
    {
      "Role": "Business Owner",
      "Name": "",
      "Title": ""
    },
    {
      "Role": "Technical Owner",
      "Name": "",
      "Title": ""
    }
  ],
  "Description": "The following analytic identifies failed authentication attempts against an Azure AD tenant during the Multi-Factor Authentication (MFA) challenge, specifically flagged by error code 500121. It leverages Azure AD SignInLogs to detect these events. This activity is significant as it may indicate an adversary attempting to authenticate using compromised credentials on an account with MFA enabled. If confirmed malicious, this could suggest an ongoing effort to bypass MFA protections, potentially leading to unauthorized access and further compromise of the affected account.",
  "Assumptions": "Assumptions:\n- Azure AD SignInLogs are being ingested via EventHub\n- Splunk Add-on for Microsoft Cloud Services is installed\n- MFA is enabled for users in the environment\n\nPotential Impact:\n- Compromised credentials being used against MFA-protected accounts\n- Potential MFA fatigue attacks\n- Unauthorized access attempts",
  "origin": "custom",
  "Detection Name": "Azure AD Authentication Failed During MFA Challenge",
  "Objective": "Detect and alert on failed MFA authentication attempts which may indicate credential compromise or MFA bypass attempts.",
  "Severity/Priority": "Medium",
  "Analyst Next Steps": "1. Review the authentication methods attempted by the user\n2. Check the source IP for known malicious activity\n3. Contact the user to verify if they initiated the sign-in attempt\n4. Review for any successful authentications from the same source\n5. Consider blocking the source IP if malicious activity is confirmed",
  "Blind_Spots_False_Positives": "Blind Spots:\n- MFA failures not captured in SignInLogs\n- Authentication attempts through federated identity providers\n\nFalse Positives:\n- False positives have been minimized by removing attempts that result in 'MFA successfully completed messages', which were found to be generated when a user opts to use a different MFA method than the default. Further reductions in finding events can be achieved through filtering 'MFA denied; duplicate authentication attempt' messages within the auth_msg field, as they could arguably be considered as false positives.",
  "Required_Data_Sources": "Azure Active Directory SignInLogs",
  "First Created": "2025-05-02T00:00:00.000Z",
  "Last Modified": "2026-01-22T00:00:00.000Z",
  "Search String": "`azure_monitor_aad` category=SignInLogs properties.status.errorCode=500121 | rename properties.* as *, authenticationDetails{}.* as * | eval time=strptime(authenticationStepDateTime,\"%Y-%m-%dT%H:%M:%S\") | eval auth_detail=mvzip(strftime(time, \"%Y-%m-%dT%H:%M:%S\"),authenticationStepResultDetail,\" - \"), auth_msg=mvappend('status.additionalDetails', authenticationStepResultDetail) | eval auth_method=mvmap(authenticationMethod, if(isnull(mvfind('mfaDetail.authMethod',authenticationMethod)), authenticationMethod, null())) | search NOT auth_msg=\"MFA successfully completed\" | rename userAgent as user_agent | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest user src vendor_account vendor_product auth_method auth_msg user_agent signature | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `azure_ad_authentication_failed_during_mfa_challenge_filter`",
  "Splunk_App_Context": "search",
  "Search_Duration": "-15m",
  "Cron Schedule": "*/15 * * * *",
  "Schedule Window": "5",
  "Schedule Priority": "default",
  "Trigger Condition": "Number of results is greater than 0",
  "Throttling": {
    "enabled": 1,
    "fields": "user",
    "period": "1h"
  },
  "Risk": [
    {
      "risk_object_field": "user",
      "risk_object_type": "user",
      "risk_score": 54
    }
  ],
  "Notable Title": "Azure AD Authentication Failed During MFA Challenge for $user$",
  "Notable Description": "User $user$ failed to pass MFA challenge",
  "Security Domain": "identity",
  "Drilldown Name (Legacy)": "View Events Associated to this Notable on Identity",
  "Drilldown Search (Legacy)": "`azure_monitor_aad` category=SignInLogs user=\"$user$\" | table _time user src auth_method auth_msg",
  "Drilldown Earliest Offset (Legacy)": "2592000",
  "Drilldown Latest Offset (Legacy)": "86400",
  "Mitre ID": [
    "T1078.004",
    "T1586.003",
    "T1621"
  ],
  "Drilldown Name 1": "View the detection results for - \"$user$\"",
  "Drilldown Search 1": "%original_detection_search% | search  user = \"$user$\"",
  "Drilldown Earliest 1": "$info_min_time$",
  "Drilldown Latest 1": "$info_max_time$",
  "Drilldown Name 2": "View risk events for the last 7 days for - \"$user$\"",
  "Drilldown Search 2": "| from datamodel Risk.All_Risk | search normalized_risk_object IN (\"$user$\") starthoursago=168  | stats count min(_time) as firstTime max(_time) as lastTime values(search_name) as \"Search Name\" values(risk_message) as \"Risk Message\" values(analyticstories) as \"Analytic Stories\" values(annotations._all) as \"Annotations\" values(annotations.mitre_attack.mitre_tactic) as \"ATT&CK Tactics\" by normalized_risk_object | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`",
  "Drilldown Earliest 2": "$info_min_time$",
  "Drilldown Latest 2": "$info_max_time$",
  "Drilldown Name 3": "",
  "Drilldown Search 3": "",
  "Drilldown Earliest 3": null,
  "Drilldown Latest 3": null,
  "Drilldown Name 4": "",
  "Drilldown Search 4": "",
  "Drilldown Earliest 4": null,
  "Drilldown Latest 4": null,
  "Drilldown Name 5": "",
  "Drilldown Search 5": "",
  "Drilldown Earliest 5": null,
  "Drilldown Latest 5": null,
  "Drilldown Name 6": "",
  "Drilldown Search 6": "",
  "Drilldown Earliest 6": null,
  "Drilldown Latest 6": null,
  "Drilldown Name 7": "",
  "Drilldown Search 7": "",
  "Drilldown Earliest 7": null,
  "Drilldown Latest 7": null,
  "Drilldown Name 8": "",
  "Drilldown Search 8": "",
  "Drilldown Earliest 8": null,
  "Drilldown Latest 8": null,
  "Drilldown Name 9": "",
  "Drilldown Search 9": "",
  "Drilldown Earliest 9": null,
  "Drilldown Latest 9": null,
  "Drilldown Name 10": "",
  "Drilldown Search 10": "",
  "Drilldown Earliest 10": null,
  "Drilldown Latest 10": null,
  "Drilldown Name 11": "",
  "Drilldown Search 11": "",
  "Drilldown Earliest 11": null,
  "Drilldown Latest 11": null,
  "Drilldown Name 12": "",
  "Drilldown Search 12": "",
  "Drilldown Earliest 12": null,
  "Drilldown Latest 12": null,
  "Drilldown Name 13": "",
  "Drilldown Search 13": "",
  "Drilldown Earliest 13": null,
  "Drilldown Latest 13": null,
  "Drilldown Name 14": "",
  "Drilldown Search 14": "",
  "Drilldown Earliest 14": null,
  "Drilldown Latest 14": null,
  "Drilldown Name 15": "",
  "Drilldown Search 15": "",
  "Drilldown Earliest 15": null,
  "Drilldown Latest 15": null,
  "Proposed Test Plan": ""
}