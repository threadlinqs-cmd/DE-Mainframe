<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DE-MainFrame</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Password Protection Modal -->
    <div id="modal-password" class="modal password-modal">
        <div class="modal-overlay no-close"></div>
        <div class="modal-content password-modal-content">
            <div class="modal-header">
                <div class="password-lock-icon">ðŸ”’</div>
                <h3>DE-MainFrame Access</h3>
            </div>
            <div class="modal-body">
                <p class="password-prompt">Enter password to continue</p>
                <div class="form-group">
                    <input type="password" id="password-input" class="password-input" placeholder="Password" autocomplete="off">
                </div>
                <p id="password-error" class="password-error hidden">Incorrect password</p>
            </div>
            <div class="modal-footer">
                <button id="btn-password-submit" class="btn-primary" onclick="validatePassword()">Unlock</button>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Collapsible Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Navigation</span>
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Close sidebar">Ã—</button>
            </div>
            <nav class="sidebar-nav">
                <a href="#library" class="nav-item active" data-key="1">Library</a>
                <a href="#editor" class="nav-item" data-key="2">Editor</a>
                <a href="#macros" class="nav-item" data-key="3">Macros</a>
                <a href="#revalidation" class="nav-item" data-key="4">Revalidation</a>
                <a href="#history" class="nav-item" data-key="5">History</a>
                <a href="#resources" class="nav-item" data-key="6">Resources</a>
                <a href="#reports" class="nav-item" data-key="7">Reports</a>
                <a href="#settings" class="nav-item" data-key="8">Settings</a>
            </nav>
        </aside>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Header Bar -->
            <header class="header-bar">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">â˜°</button>
                    <h1 class="header-title">DE-MainFrame</h1>
                </div>
                <div class="header-right">
                    <span class="header-subtitle">Detection Engineering</span>
                    <button class="settings-btn" onclick="openSettingsModal()" aria-label="Settings" title="Settings">&#x2699;</button>
                    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme" title="Toggle light/dark theme">â˜€</button>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="content-area">
                <!-- Library View -->
                <section id="view-library" class="view active">
                    <div class="library-layout">
                        <!-- Sidebar - Filters + Detection List -->
                        <aside class="library-sidebar" id="library-sidebar">
                            <button class="library-sidebar-toggle" id="library-sidebar-toggle" title="Toggle filters panel">
                                <span class="toggle-icon">
                                    <span class="burger-line"></span>
                                    <span class="burger-line"></span>
                                    <span class="burger-line"></span>
                                </span>
                            </button>
                            <div class="sidebar-content">
                                <div class="library-search">
                                    <input type="text" id="library-search-input" class="search-input" placeholder="Search detections...">
                                </div>
                            <div class="library-filters">
                                <div class="filter-row">
                                    <select id="filter-severity" class="filter-select">
                                        <option value="">All Severities</option>
                                        <option value="critical">Critical</option>
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                        <option value="informational">Informational</option>
                                    </select>
                                    <select id="filter-status" class="filter-select">
                                        <option value="">All Status</option>
                                        <option value="valid">Valid</option>
                                        <option value="incomplete">Incomplete</option>
                                        <option value="needs-tune">Needs Tune</option>
                                        <option value="needs-retrofit">Needs Retrofit</option>
                                    </select>
                                </div>
                                <div class="filter-row">
                                    <select id="filter-domain" class="filter-select">
                                        <option value="">All Domains</option>
                                        <option value="access">Access</option>
                                        <option value="endpoint">Endpoint</option>
                                        <option value="network">Network</option>
                                        <option value="threat">Threat</option>
                                        <option value="identity">Identity</option>
                                        <option value="audit">Audit</option>
                                    </select>
                                    <select id="filter-datasource" class="filter-select">
                                        <option value="">All Datasources</option>
                                    </select>
                                </div>
                                <div class="filter-row">
                                    <select id="filter-mitre" class="filter-select">
                                        <option value="">All MITRE</option>
                                    </select>
                                    <select id="filter-origin" class="filter-select">
                                        <option value="">All Origins</option>
                                        <option value="custom">Custom</option>
                                        <option value="escu">ESCU</option>
                                        <option value="sigma">Sigma</option>
                                    </select>
                                </div>
                                <div class="filter-row">
                                    <select id="filter-sourcetype" class="filter-select">
                                        <option value="">All Sourcetypes</option>
                                    </select>
                                    <select id="filter-main-search-field" class="filter-select">
                                        <option value="">Search Fields</option>
                                    </select>
                                </div>
                                <div class="filter-row">
                                    <select id="filter-search-function" class="filter-select">
                                        <option value="">SPL Commands</option>
                                    </select>
                                    <select id="filter-drilldown-var" class="filter-select">
                                        <option value="">Drilldown Vars</option>
                                    </select>
                                </div>
                                <div class="filter-row">
                                    <select id="filter-sort" class="filter-select">
                                        <option value="name-asc">Name (A-Z)</option>
                                        <option value="name-desc">Name (Z-A)</option>
                                        <option value="modified-desc">Modified (Newest)</option>
                                        <option value="risk-desc">Risk (Highest)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="library-list-header">
                                <span id="library-count">0 detections</span>
                            </div>
                            <div id="library-list" class="library-list"></div>
                            </div><!-- End sidebar-content -->
                        </aside>
                        <!-- Main content area - Detection Document -->
                        <div class="library-main" id="library-main">
                            <button class="library-main-toggle" id="library-main-toggle" title="Toggle detail panel">
                                <span class="toggle-arrow">&#x25C0;</span>
                            </button>
                            <div id="detail-placeholder" class="detail-placeholder">
                                <span class="placeholder-icon">ðŸ“‹</span>
                                <p>Select a detection from the sidebar to view documentation</p>
                            </div>
                            <div id="library-detail-content" class="library-detail-content hidden">
                                <div class="detail-header">
                                    <div class="view-toggle" id="detail-view-toggle">
                                        <button class="view-toggle-btn active" data-view="structured">Structured</button>
                                        <button class="view-toggle-btn" data-view="json">JSON</button>
                                    </div>
                                    <div class="detail-actions">
                                        <!-- View Actions Group -->
                                        <div class="action-group view-actions">
                                            <button id="btn-detail-correlation" class="btn-action" title="Edit Correlation Search in Splunk">Correlation</button>
                                            <button id="btn-detail-metadata" class="btn-action" title="View Metadata">Metadata</button>
                                        </div>
                                        <!-- Edit Actions Group -->
                                        <div class="action-group edit-actions">
                                            <button id="btn-detail-tune" class="btn-action" title="Record Tuning">Tune</button>
                                            <button id="btn-detail-retrofit" class="btn-action" title="Record Retrofit">Retrofit</button>
                                            <button id="btn-detail-edit" class="btn-action btn-primary" title="Edit Detection">Edit</button>
                                            <button id="btn-detail-delete" class="btn-action btn-danger" title="Delete Detection">Delete</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="library-detail-body" class="detail-body"></div>
                                <div id="detail-json-view" class="detail-body hidden"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Editor View -->
                <section id="view-editor" class="view">
                    <div class="editor-layout">
                        <!-- Editor Main Content -->
                        <div class="editor-main">
                            <!-- Editor Toolbar -->
                            <div class="editor-toolbar">
                                <div class="editor-toolbar-left">
                                    <button id="btn-editor-new" class="btn-action" onclick="createNewDetection()">New</button>
                                    <button id="btn-editor-load" class="btn-action" onclick="openLoadModal()">Load</button>
                                    <button id="btn-editor-clear" class="btn-action" onclick="clearForm()">Clear</button>
                                </div>
                                <div class="editor-toolbar-tabs">
                                    <button class="editor-tab-btn active" data-tab="form" onclick="switchEditorTab('form')">Form</button>
                                    <button class="editor-tab-btn" data-tab="json" onclick="switchEditorTab('json')">JSON</button>
                                </div>
                                <div class="editor-toolbar-right">
                                    <button id="btn-editor-cancel" class="btn-action" onclick="cancelEditor()">Cancel</button>
                                    <button id="btn-editor-download" class="btn-action" onclick="downloadCurrentDetection()">Download</button>
                                    <button id="btn-editor-save" class="btn-action btn-primary" onclick="saveDetection()" disabled>Save</button>
                                </div>
                            </div>

                            <!-- Form Tab -->
                            <div id="editor-tab-form" class="editor-tab-content active">
                                <form id="detection-form" class="detection-form">
                                    <!-- Section 1: Basic Information -->
                                    <div class="form-section" data-section="1">
                                        <div class="section-header" onclick="toggleFormSection(1)">
                                            <span class="section-toggle">-</span>
                                            <h3>Basic Information</h3>
                                        </div>
                                        <div class="section-content">
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-detection-name">Detection Name <span class="required">*</span></label>
                                                    <input type="text" id="field-detection-name" name="Detection Name" class="form-input" placeholder="e.g., Access - T1059 - Command Line Interface">
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-objective">Objective <span class="required">*</span></label>
                                                    <textarea id="field-objective" name="Objective" class="form-textarea" rows="3" placeholder="What does this detection aim to identify?"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-description">Description</label>
                                                    <textarea id="field-description" name="Description" class="form-textarea" rows="3" placeholder="Detailed description of the detection"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-row two-col">
                                                <div class="form-group">
                                                    <label for="field-severity">Severity/Priority <span class="required">*</span></label>
                                                    <select id="field-severity" name="Severity/Priority" class="form-select">
                                                        <option value="">Select Severity</option>
                                                        <option value="critical">Critical</option>
                                                        <option value="high">High</option>
                                                        <option value="medium">Medium</option>
                                                        <option value="low">Low</option>
                                                        <option value="informational">Informational</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="field-domain">Security Domain</label>
                                                    <select id="field-domain" name="Security Domain" class="form-select">
                                                        <option value="">Select Domain</option>
                                                        <option value="access">Access</option>
                                                        <option value="endpoint">Endpoint</option>
                                                        <option value="network">Network</option>
                                                        <option value="threat">Threat</option>
                                                        <option value="identity">Identity</option>
                                                        <option value="audit">Audit</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-row two-col">
                                                <div class="form-group">
                                                    <label for="field-origin">Origin</label>
                                                    <select id="field-origin" name="origin" class="form-select">
                                                        <option value="custom">Custom</option>
                                                        <option value="escu">ESCU</option>
                                                        <option value="sigma">Sigma</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label>Roles & Ownership</label>
                                                    <div class="roles-container" id="roles-container">
                                                        <div class="role-row">
                                                            <span class="role-label">Requestor:</span>
                                                            <input type="text" id="field-role-requestor-name" class="form-input" placeholder="Name">
                                                            <input type="text" id="field-role-requestor-title" class="form-input" placeholder="Title">
                                                        </div>
                                                        <div class="role-row">
                                                            <span class="role-label">Business Owner:</span>
                                                            <input type="text" id="field-role-business-name" class="form-input" placeholder="Name">
                                                            <input type="text" id="field-role-business-title" class="form-input" placeholder="Title">
                                                        </div>
                                                        <div class="role-row">
                                                            <span class="role-label">Technical Owner:</span>
                                                            <input type="text" id="field-role-technical-name" class="form-input" placeholder="Name">
                                                            <input type="text" id="field-role-technical-title" class="form-input" placeholder="Title">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="mitre-input">MITRE ATT&CK IDs</label>
                                                    <div class="tag-input-container" id="mitre-container">
                                                        <div id="mitre-tags" class="tags-inline"></div>
                                                        <input type="text" id="mitre-input" class="tag-input" placeholder="T1234 or T1234.001 + Enter">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 2: Search Configuration -->
                                    <div class="form-section" data-section="2">
                                        <div class="section-header" onclick="toggleFormSection(2)">
                                            <span class="section-toggle">-</span>
                                            <h3>Search Configuration</h3>
                                        </div>
                                        <div class="section-content">
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-search-string">Search String (SPL) <span class="required">*</span></label>
                                                    <textarea id="field-search-string" name="Search String" class="form-textarea code-input" rows="8" placeholder="| search index=..."></textarea>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="datasource-input">Required Data Sources <span class="required">*</span></label>
                                                    <div class="tag-input-container">
                                                        <div id="datasource-tags" class="tags"></div>
                                                        <input type="text" id="datasource-input" class="form-input tag-input" placeholder="Type and press Enter to add...">
                                                    </div>
                                                    <small class="form-hint">Auto-populated from SPL. You can also add manually by typing and pressing Enter.</small>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-assumptions">Assumptions</label>
                                                    <textarea id="field-assumptions" name="Assumptions" class="form-textarea" rows="2" placeholder="Environmental assumptions for this detection"></textarea>
                                                </div>
                                            </div>

                                            <!-- Parsed SPL Metadata Preview -->
                                            <div id="spl-parsed-preview" class="spl-parsed-preview hidden">
                                                <div class="spl-parsed-title">Parsed from SPL</div>
                                                <div id="spl-parsed-content" class="spl-parsed-content"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 3: Risk Configuration (Collapsible) -->
                                    <div class="form-section collapsed" data-section="3">
                                        <div class="section-header" onclick="toggleFormSection(3)">
                                            <span class="section-toggle">+</span>
                                            <h3>Risk Configuration</h3>
                                        </div>
                                        <div class="section-content">
                                            <div id="risk-entries-container">
                                                <div class="risk-entry" data-risk-index="0">
                                                    <div class="form-row three-col">
                                                        <div class="form-group">
                                                            <label>Risk Object Field <span class="required">*</span></label>
                                                            <input type="text" class="form-input risk-field" placeholder="e.g., $user$">
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Risk Object Type</label>
                                                            <select class="form-select risk-type">
                                                                <option value="user">User</option>
                                                                <option value="system">System</option>
                                                                <option value="other">Other</option>
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Risk Score <span class="required">*</span></label>
                                                            <input type="number" class="form-input risk-score" min="0" max="100" value="0">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" class="btn-action btn-small" onclick="addRiskEntry()">+ Add Risk Entry</button>
                                        </div>
                                    </div>

                                    <!-- Section 4: Notable Event -->
                                    <div class="form-section" data-section="4">
                                        <div class="section-header" onclick="toggleFormSection(4)">
                                            <span class="section-toggle">-</span>
                                            <h3>Notable Event</h3>
                                        </div>
                                        <div class="section-content">
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-notable-title">Notable Title <span class="required">*</span></label>
                                                    <input type="text" id="field-notable-title" name="Notable Title" class="form-input" placeholder="Auto-populated from Detection Name">
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-notable-desc">Notable Description</label>
                                                    <textarea id="field-notable-desc" name="Notable Description" class="form-textarea" rows="3" placeholder="Description shown in notable event"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-analyst-steps">Analyst Next Steps <span class="required">*</span></label>
                                                    <textarea id="field-analyst-steps" name="Analyst Next Steps" class="form-textarea" rows="4" placeholder="Step-by-step investigation guidance"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-blind-spots">Blind Spots / False Positives <span class="required">*</span></label>
                                                    <textarea id="field-blind-spots" name="Blind_Spots_False_Positives" class="form-textarea" rows="3" placeholder="Known limitations and potential false positives"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 5: Scheduling (Collapsible) -->
                                    <div class="form-section collapsed" data-section="5">
                                        <div class="section-header" onclick="toggleFormSection(5)">
                                            <span class="section-toggle">+</span>
                                            <h3>Scheduling</h3>
                                        </div>
                                        <div class="section-content">
                                            <div class="form-row three-col">
                                                <div class="form-group">
                                                    <label for="field-cron">Cron Schedule</label>
                                                    <input type="text" id="field-cron" name="Cron Schedule" class="form-input" placeholder="*/5 * * * *">
                                                </div>
                                                <div class="form-group">
                                                    <label for="field-schedule-window">Schedule Window</label>
                                                    <input type="text" id="field-schedule-window" name="Schedule Window" class="form-input" placeholder="auto">
                                                </div>
                                                <div class="form-group">
                                                    <label for="field-schedule-priority">Schedule Priority</label>
                                                    <select id="field-schedule-priority" name="Schedule Priority" class="form-select">
                                                        <option value="">Default</option>
                                                        <option value="higher">Higher</option>
                                                        <option value="highest">Highest</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-trigger">Trigger Condition</label>
                                                    <input type="text" id="field-trigger" name="Trigger Condition" class="form-input" placeholder="search count > 0">
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <h4 class="sub-section-title">Throttling</h4>
                                            </div>
                                            <div class="form-row three-col">
                                                <div class="form-group">
                                                    <label for="field-throttle-enabled">Throttle Enabled</label>
                                                    <select id="field-throttle-enabled" class="form-select">
                                                        <option value="0">No</option>
                                                        <option value="1">Yes</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="field-throttle-fields">Throttle Fields</label>
                                                    <input type="text" id="field-throttle-fields" class="form-input" placeholder="user, dest">
                                                </div>
                                                <div class="form-group">
                                                    <label for="field-throttle-period">Throttle Period</label>
                                                    <input type="text" id="field-throttle-period" class="form-input" placeholder="86400s">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 6: Drilldowns (Collapsible) -->
                                    <div class="form-section collapsed" data-section="6">
                                        <div class="section-header" onclick="toggleFormSection(6)">
                                            <span class="section-toggle">+</span>
                                            <h3>Drilldowns</h3>
                                        </div>
                                        <div class="section-content">
                                            <div id="drilldowns-container">
                                                <!-- Drilldowns will be added dynamically -->
                                            </div>
                                            <button type="button" class="btn-action btn-small" onclick="addDrilldown()">+ Add Drilldown</button>
                                        </div>
                                    </div>

                                    <!-- Section 7: Test Plan (Collapsible) -->
                                    <div class="form-section collapsed" data-section="7">
                                        <div class="section-header" onclick="toggleFormSection(7)">
                                            <span class="section-toggle">+</span>
                                            <h3>Proposed Test Plan</h3>
                                        </div>
                                        <div class="section-content">
                                            <div class="form-row">
                                                <div class="form-group full-width">
                                                    <label for="field-test-plan">Test Plan</label>
                                                    <textarea id="field-test-plan" name="Proposed Test Plan" class="form-textarea" rows="4" placeholder="Steps to validate this detection"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- JSON Tab -->
                            <div id="editor-tab-json" class="editor-tab-content">
                                <div class="json-editor-container">
                                    <textarea id="json-editor" class="json-editor" placeholder="Paste or edit JSON here..."></textarea>
                                    <div class="json-editor-actions">
                                        <button class="btn-action" onclick="formatJson()">Format JSON</button>
                                        <button class="btn-action" onclick="applyJsonToForm()">Apply to Form</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Validation Sidebar -->
                        <aside class="editor-sidebar">
                            <div class="validation-panel">
                                <div class="validation-header">
                                    <h3>Validation</h3>
                                    <span id="validation-status" class="validation-status">Not Ready</span>
                                </div>
                                <div id="validation-content" class="validation-content">
                                    <div class="validation-section">
                                        <h4>Required Fields</h4>
                                        <ul id="validation-errors" class="validation-list">
                                            <li class="validation-item error">Detection Name is required</li>
                                        </ul>
                                    </div>
                                    <div class="validation-section">
                                        <h4>Warnings</h4>
                                        <ul id="validation-warnings" class="validation-list">
                                            <!-- Warnings will be populated here -->
                                        </ul>
                                    </div>
                                    <div class="validation-section">
                                        <h4 id="missing-macros-header" class="hidden">Missing Macros</h4>
                                        <ul id="missing-macros-list" class="validation-list macro-list">
                                            <!-- Missing macros will be clickable links -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </div>
                </section>
                <!-- Macros View -->
                <section id="view-macros" class="view">
                    <div class="macros-layout">
                        <!-- Macros Sidebar -->
                        <aside class="macros-sidebar">
                            <div class="macros-toolbar">
                                <button id="btn-macro-new" class="btn-action btn-primary" onclick="createNewMacro()">+ New Macro</button>
                            </div>
                            <div class="macros-search">
                                <input type="text" id="macros-search-input" class="search-input" placeholder="Search macros..." oninput="filterMacros()">
                            </div>
                            <div class="macros-filter-row">
                                <select id="macros-sort" class="filter-select" onchange="filterMacros()">
                                    <option value="name-asc">Name A-Z</option>
                                    <option value="name-desc">Name Z-A</option>
                                    <option value="most-used">Most Used</option>
                                    <option value="least-used">Least Used</option>
                                </select>
                                <label class="toggle-label">
                                    <input type="checkbox" id="macros-show-deprecated" onchange="filterMacros()">
                                    <span>Show deprecated</span>
                                </label>
                            </div>
                            <div class="macros-list-header">
                                <span id="macros-count">0 macros</span>
                            </div>
                            <div id="macros-list" class="macros-list"></div>
                        </aside>

                        <!-- Macro Detail/Edit Panel -->
                        <div class="macros-main">
                            <div id="macro-placeholder" class="detail-placeholder">
                                <span class="placeholder-icon">&#x2699;</span>
                                <p>Select a macro from the sidebar or create a new one</p>
                            </div>
                            <div id="macro-detail-content" class="macro-detail-content hidden">
                                <div class="macro-detail-header">
                                    <h3 id="macro-detail-title">Macro Details</h3>
                                    <div class="macro-detail-actions">
                                        <button id="btn-macro-cancel" class="btn-action" onclick="cancelMacroEdit()">Cancel</button>
                                        <button id="btn-macro-save" class="btn-action btn-primary" onclick="saveMacroEdit()">Save</button>
                                        <button id="btn-macro-delete" class="btn-action btn-danger" onclick="confirmDeleteMacroUI()">Delete</button>
                                    </div>
                                </div>
                                <div class="macro-detail-body">
                                    <form id="macro-form" class="macro-form">
                                        <div class="form-group">
                                            <label for="macro-field-name">Macro Name <span class="required">*</span></label>
                                            <input type="text" id="macro-field-name" class="form-input" placeholder="my_macro_name">
                                            <small class="form-hint">No spaces allowed, use underscores. Example: security_content_summariesonly</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="macro-field-definition">Definition <span class="required">*</span></label>
                                            <textarea id="macro-field-definition" class="form-textarea code-input" rows="6" placeholder="summariesonly=true"></textarea>
                                            <small class="form-hint">SPL fragment that this macro expands to</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="macro-field-description">Description</label>
                                            <textarea id="macro-field-description" class="form-textarea" rows="3" placeholder="What does this macro do?"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="macro-field-arguments">Arguments</label>
                                            <input type="text" id="macro-field-arguments" class="form-input" placeholder="arg1, arg2">
                                            <small class="form-hint">Comma-separated list of arguments (e.g., earliest, latest)</small>
                                        </div>
                                        <div class="form-group">
                                            <label class="toggle-label inline">
                                                <input type="checkbox" id="macro-field-deprecated">
                                                <span>Mark as deprecated</span>
                                            </label>
                                        </div>
                                    </form>

                                    <!-- Usage Section -->
                                    <div id="macro-usage-section" class="macro-usage-section hidden">
                                        <h4>Usage in Detections</h4>
                                        <div id="macro-usage-list" class="macro-usage-list">
                                            <!-- Detection usage will be listed here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Revalidation View -->
                <section id="view-revalidation" class="view">
                    <div class="revalidation-layout">
                        <!-- Sidebar - Filters + Detection List -->
                        <aside class="revalidation-sidebar">
                            <!-- Status Classification Checkboxes -->
                            <div class="revalidation-status-filters">
                                <div class="status-filter-header">Status Classification</div>
                                <div class="status-checkbox-group">
                                    <label class="status-checkbox valid">
                                        <input type="checkbox" id="reval-status-valid" checked onchange="filterRevalidation()">
                                        <span class="status-label">Valid</span>
                                        <span id="reval-count-valid" class="status-count">0</span>
                                    </label>
                                    <label class="status-checkbox incomplete">
                                        <input type="checkbox" id="reval-status-incomplete" checked onchange="filterRevalidation()">
                                        <span class="status-label">Incomplete</span>
                                        <span id="reval-count-incomplete" class="status-count">0</span>
                                    </label>
                                    <label class="status-checkbox needs-tune">
                                        <input type="checkbox" id="reval-status-needs-tune" checked onchange="filterRevalidation()">
                                        <span class="status-label">Needs Tune</span>
                                        <span id="reval-count-needs-tune" class="status-count">0</span>
                                    </label>
                                    <label class="status-checkbox needs-retrofit">
                                        <input type="checkbox" id="reval-status-needs-retrofit" checked onchange="filterRevalidation()">
                                        <span class="status-label">Needs Retrofit</span>
                                        <span id="reval-count-needs-retrofit" class="status-count">0</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Batch Operations -->
                            <div class="revalidation-batch-ops">
                                <div class="batch-ops-header">Batch Operations</div>
                                <div class="batch-ops-buttons">
                                    <button class="btn-action btn-batch" id="btn-batch-tune" onclick="batchMarkAsTuned()" disabled>Mark as Tuned</button>
                                    <button class="btn-action btn-batch" id="btn-batch-retrofit" onclick="batchMarkAsRetrofitted()" disabled>Mark as Retrofitted</button>
                                </div>
                                <div id="batch-selection-count" class="batch-selection-info">Select detections below</div>
                            </div>

                            <!-- Splunk Dashboard Link -->
                            <div class="revalidation-splunk-link">
                                <button class="btn-action btn-splunk-dashboard" onclick="openSplunkRevalidationDashboard()">
                                    <span class="splunk-icon">&#x1F4CA;</span> Open Splunk Revalidation Dashboard
                                </button>
                            </div>

                            <!-- Detection List Header -->
                            <div class="revalidation-list-header">
                                <label class="select-all-checkbox">
                                    <input type="checkbox" id="reval-select-all" onchange="toggleRevalidationSelectAll()">
                                    <span>Select All</span>
                                </label>
                                <span id="revalidation-count">0 detections</span>
                            </div>

                            <!-- Detection List -->
                            <div id="revalidation-list" class="revalidation-list"></div>
                        </aside>

                        <!-- Main content area - Detection Detail -->
                        <div class="revalidation-main">
                            <div id="reval-detail-placeholder" class="detail-placeholder">
                                <span class="placeholder-icon">&#x1F504;</span>
                                <p>Select a detection from the sidebar to view revalidation details</p>
                            </div>
                            <div id="reval-detail-content" class="revalidation-detail-content hidden">
                                <div class="reval-detail-header">
                                    <div class="reval-detail-actions">
                                        <button id="btn-reval-correlation" class="btn-action" title="Edit Correlation Search in Splunk">Correlation</button>
                                        <button id="btn-reval-tune" class="btn-action btn-primary" title="Mark as Tuned">Mark as Tuned</button>
                                        <button id="btn-reval-retrofit" class="btn-action btn-primary" title="Mark as Retrofitted">Mark as Retrofitted</button>
                                        <button id="btn-reval-view-library" class="btn-action" title="View in Library">View in Library</button>
                                    </div>
                                </div>
                                <div id="reval-detail-body" class="reval-detail-body"></div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- History View -->
                <section id="view-history" class="view">
                    <div class="history-layout">
                        <!-- Sidebar - Filters -->
                        <aside class="history-sidebar">
                            <!-- Date Range Filter -->
                            <div class="history-filter-section">
                                <div class="filter-section-header">Date Range</div>
                                <div class="date-range-picker">
                                    <div class="form-group">
                                        <label for="history-date-from">From</label>
                                        <input type="date" id="history-date-from" class="form-input date-input" onchange="filterHistory()">
                                    </div>
                                    <div class="form-group">
                                        <label for="history-date-to">To</label>
                                        <input type="date" id="history-date-to" class="form-input date-input" onchange="filterHistory()">
                                    </div>
                                    <div class="date-range-presets">
                                        <button class="preset-btn" onclick="setDatePreset('7d')">7 days</button>
                                        <button class="preset-btn" onclick="setDatePreset('30d')">30 days</button>
                                        <button class="preset-btn" onclick="setDatePreset('90d')">90 days</button>
                                        <button class="preset-btn" onclick="setDatePreset('all')">All time</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Change Type Filter -->
                            <div class="history-filter-section">
                                <div class="filter-section-header">Change Type</div>
                                <div class="change-type-checkboxes">
                                    <label class="change-type-checkbox created">
                                        <input type="checkbox" id="history-type-created" checked onchange="filterHistory()">
                                        <span class="change-type-label">Created</span>
                                        <span id="history-count-created" class="change-type-count">0</span>
                                    </label>
                                    <label class="change-type-checkbox tuned">
                                        <input type="checkbox" id="history-type-tuned" checked onchange="filterHistory()">
                                        <span class="change-type-label">Tuned</span>
                                        <span id="history-count-tuned" class="change-type-count">0</span>
                                    </label>
                                    <label class="change-type-checkbox retrofitted">
                                        <input type="checkbox" id="history-type-retrofitted" checked onchange="filterHistory()">
                                        <span class="change-type-label">Retrofitted</span>
                                        <span id="history-count-retrofitted" class="change-type-count">0</span>
                                    </label>
                                    <label class="change-type-checkbox modified">
                                        <input type="checkbox" id="history-type-modified" checked onchange="filterHistory()">
                                        <span class="change-type-label">Modified</span>
                                        <span id="history-count-modified" class="change-type-count">0</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Detection Name Search -->
                            <div class="history-filter-section">
                                <div class="filter-section-header">Detection Search</div>
                                <div class="history-search">
                                    <input type="text" id="history-search-input" class="search-input" placeholder="Search detections..." oninput="filterHistory()">
                                </div>
                            </div>

                            <!-- Results Count -->
                            <div class="history-list-header">
                                <span id="history-count">0 changes</span>
                            </div>
                        </aside>

                        <!-- Main content area - Timeline -->
                        <div class="history-main">
                            <div id="history-timeline" class="history-timeline">
                                <!-- Timeline entries will be populated here -->
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Resources View -->
                <section id="view-resources" class="view">
                    <div class="resources-layout">
                        <!-- Resources Main Area -->
                        <div class="resources-main">
                            <!-- Resources Toolbar -->
                            <div class="resources-toolbar">
                                <h2 class="resources-title">Resources</h2>
                                <button id="btn-add-resource" class="btn-action btn-primary" onclick="openAddResourceModal()">+ Add Resource</button>
                            </div>

                            <!-- Resources Grouped by Category -->
                            <div id="resources-container" class="resources-container">
                                <!-- Dashboard Category -->
                                <div class="resource-category" data-category="dashboard">
                                    <div class="category-header">
                                        <span class="category-icon">&#x1F4CA;</span>
                                        <h3>Dashboards</h3>
                                        <span id="count-dashboard" class="category-count">0</span>
                                    </div>
                                    <div id="resources-dashboard" class="resource-list">
                                        <!-- Dashboard resources will be rendered here -->
                                    </div>
                                </div>

                                <!-- External URL Category -->
                                <div class="resource-category" data-category="external">
                                    <div class="category-header">
                                        <span class="category-icon">&#x1F310;</span>
                                        <h3>External URLs</h3>
                                        <span id="count-external" class="category-count">0</span>
                                    </div>
                                    <div id="resources-external" class="resource-list">
                                        <!-- External URL resources will be rendered here -->
                                    </div>
                                </div>

                                <!-- Internal URL Category -->
                                <div class="resource-category" data-category="internal">
                                    <div class="category-header">
                                        <span class="category-icon">&#x1F3E2;</span>
                                        <h3>Internal URLs</h3>
                                        <span id="count-internal" class="category-count">0</span>
                                    </div>
                                    <div id="resources-internal" class="resource-list">
                                        <!-- Internal URL resources will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Reports View -->
                <section id="view-reports" class="view">
                    <div class="reports-container">
                        <!-- Sub-Tab Navigation -->
                        <div class="reports-tabs">
                            <button class="reports-tab active" data-tab="overview">Overview</button>
                            <button class="reports-tab" data-tab="coverage">Detection Coverage</button>
                            <button class="reports-tab" data-tab="revalidations">Revalidations</button>
                            <button class="reports-tab" data-tab="metadata">Detection Metadata</button>
                        </div>

                        <!-- Overview Tab -->
                        <div id="reports-overview" class="reports-tab-content active">
                            <div class="reports-layout">
                                <!-- Stats Cards Row -->
                                <div class="reports-stats-row">
                                    <div class="stat-card stat-total">
                                        <div class="stat-value" id="stat-total-detections">0</div>
                                        <div class="stat-label">Total Detections</div>
                                    </div>
                                    <div class="stat-card stat-critical">
                                        <div class="stat-value" id="stat-critical">0</div>
                                        <div class="stat-label">Critical</div>
                                    </div>
                                    <div class="stat-card stat-high">
                                        <div class="stat-value" id="stat-high">0</div>
                                        <div class="stat-label">High</div>
                                    </div>
                                    <div class="stat-card stat-medium">
                                        <div class="stat-value" id="stat-medium">0</div>
                                        <div class="stat-label">Medium</div>
                                    </div>
                                    <div class="stat-card stat-low">
                                        <div class="stat-value" id="stat-low">0</div>
                                        <div class="stat-label">Low</div>
                                    </div>
                                    <div class="stat-card stat-info">
                                        <div class="stat-value" id="stat-info">0</div>
                                        <div class="stat-label">Info</div>
                                    </div>
                                </div>

                                <!-- Charts Row -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Severity Distribution</h3>
                                        <div id="chart-severity" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Risk Score Distribution</h3>
                                        <div id="chart-risk" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Security Domains</h3>
                                        <div id="chart-by-domain" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <!-- Data Sources and MITRE Row -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Data Sources</h3>
                                        <div id="chart-by-datasource" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">MITRE Techniques</h3>
                                        <div id="chart-mitre" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <!-- Recent Activity Row -->
                                <div class="reports-recent-row">
                                    <div class="reports-section recent-section">
                                        <h3 class="reports-section-title">Recently Modified</h3>
                                        <div id="list-recent-modifications" class="recent-list"></div>
                                    </div>
                                    <div class="reports-section recent-section tune">
                                        <h3 class="reports-section-title">Recent Tunes</h3>
                                        <div id="list-recent-tunes" class="recent-list"></div>
                                    </div>
                                    <div class="reports-section recent-section retrofit">
                                        <h3 class="reports-section-title">Recent Retrofits</h3>
                                        <div id="list-recent-retrofits" class="recent-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Coverage Tab -->
                        <div id="reports-coverage" class="reports-tab-content hidden">
                            <div class="reports-layout">
                                <h2 class="reports-tab-title">Detection Coverage Report</h2>

                                <!-- Coverage Summary Stats -->
                                <div class="reports-summary">
                                    <div class="report-stat">
                                        <div id="report-coverage-mitre" class="report-stat-value">0%</div>
                                        <div class="report-stat-label">MITRE Coverage</div>
                                    </div>
                                    <div class="report-stat">
                                        <div id="report-coverage-drilldowns" class="report-stat-value">0%</div>
                                        <div class="report-stat-label">Has Drilldowns</div>
                                    </div>
                                    <div class="report-stat">
                                        <div id="report-avg-risk" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Avg Risk Score</div>
                                    </div>
                                    <div class="report-stat">
                                        <div id="report-total" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Total Detections</div>
                                    </div>
                                </div>

                                <!-- Coverage Charts -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Data Sources</h3>
                                        <div id="report-datasources" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Platforms</h3>
                                        <div id="report-platforms" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Security Domains</h3>
                                        <div id="report-domains" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Origins</h3>
                                        <div id="report-origins" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <!-- MITRE Heatmap -->
                                <div class="reports-section full-width">
                                    <h3 class="reports-section-title">MITRE ATT&CK Coverage</h3>
                                    <div class="mitre-coverage-header">
                                        <span id="mitre-technique-count">0 techniques covered</span>
                                    </div>
                                    <div id="report-mitre-heatmap" class="mitre-heatmap-container"></div>
                                </div>

                                <!-- Quality Metrics -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Severity Breakdown</h3>
                                        <div id="report-severity" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Quality Metrics</h3>
                                        <div id="report-quality" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <!-- Search Fields & Functions -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Top Search Fields</h3>
                                        <div id="chart-search-fields" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Top SPL Functions</h3>
                                        <div id="chart-search-functions" class="bar-chart-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Revalidations Tab -->
                        <div id="reports-revalidations" class="reports-tab-content hidden">
                            <div class="reports-layout">
                                <h2 class="reports-tab-title">Revalidation Report</h2>

                                <!-- Revalidation Summary Stats -->
                                <div class="reports-summary">
                                    <div class="report-stat">
                                        <div id="reval-report-total" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Total Detections</div>
                                    </div>
                                    <div class="report-stat valid">
                                        <div id="reval-report-valid" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Fully Valid</div>
                                    </div>
                                    <div class="report-stat tune">
                                        <div id="reval-report-tune" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Need Tune</div>
                                    </div>
                                    <div class="report-stat retrofit">
                                        <div id="reval-report-retrofit" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Need Retrofit</div>
                                    </div>
                                </div>

                                <!-- Missing Fields & TTL -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Missing Fields Summary</h3>
                                        <div id="reval-report-fields" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">TTL Status</h3>
                                        <div id="reval-report-ttl" class="ttl-status-container"></div>
                                    </div>
                                </div>

                                <!-- History Stats -->
                                <div class="reports-summary" style="margin-top: 20px;">
                                    <div class="report-stat">
                                        <div id="reval-report-history-total" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Total History Entries</div>
                                    </div>
                                    <div class="report-stat tune">
                                        <div id="reval-report-tunes" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Total Tunes</div>
                                    </div>
                                    <div class="report-stat retrofit">
                                        <div id="reval-report-retrofits" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Total Retrofits</div>
                                    </div>
                                    <div class="report-stat">
                                        <div id="reval-report-analysts" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Unique Analysts</div>
                                    </div>
                                </div>

                                <!-- Activity Charts -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Activity by Analyst</h3>
                                        <div id="reval-report-analyst-chart" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Activity by Reason</h3>
                                        <div id="reval-report-reason-chart" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <!-- Activity Timeline -->
                                <div class="reports-section full-width">
                                    <h3 class="reports-section-title">Recent Activity Timeline</h3>
                                    <div id="reval-report-timeline" class="activity-timeline-container"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata Tab -->
                        <div id="reports-metadata" class="reports-tab-content hidden">
                            <div class="reports-layout">
                                <h2 class="reports-tab-title">Detection Metadata Report</h2>
                                <p class="reports-subtitle">Statistics based on parsed values from detection metadata files</p>

                                <!-- Metadata Summary Stats -->
                                <div class="reports-summary">
                                    <div class="report-stat">
                                        <div id="meta-report-detections" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Detections with Metadata</div>
                                    </div>
                                    <div class="report-stat">
                                        <div id="meta-report-indexes" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Unique Indexes</div>
                                    </div>
                                    <div class="report-stat">
                                        <div id="meta-report-sourcetypes" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Unique Sourcetypes</div>
                                    </div>
                                    <div class="report-stat">
                                        <div id="meta-report-functions" class="report-stat-value">0</div>
                                        <div class="report-stat-label">Unique Functions</div>
                                    </div>
                                </div>

                                <!-- Index and Sourcetype Charts -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Top Indexes</h3>
                                        <div id="meta-report-index-chart" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Top Sourcetypes</h3>
                                        <div id="meta-report-sourcetype-chart" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <!-- Fields and Functions Charts -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Main Search Fields</h3>
                                        <div id="meta-report-fields-chart" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Search Functions</h3>
                                        <div id="meta-report-func-chart" class="bar-chart-container"></div>
                                    </div>
                                </div>

                                <!-- Macros and Lookups Charts -->
                                <div class="reports-charts-row">
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Macros Used</h3>
                                        <div id="meta-report-macros-chart" class="bar-chart-container"></div>
                                    </div>
                                    <div class="reports-section chart-section">
                                        <h3 class="reports-section-title">Lookups Used</h3>
                                        <div id="meta-report-lookups-chart" class="bar-chart-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="view-settings" class="view">
                    <div class="settings-layout">
                        <!-- GitHub Connection Settings -->
                        <div class="settings-section">
                            <div class="settings-section-header">
                                <h3>GitHub Connection</h3>
                            </div>
                            <div class="settings-section-body">
                                <div class="form-row two-col">
                                    <div class="form-group">
                                        <label for="setting-github-base-url">GitHub Base URL</label>
                                        <input type="text" id="setting-github-base-url" class="form-input" placeholder="https://api.github.com">
                                        <small class="form-hint">Leave default for github.com, or enter enterprise URL</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="setting-github-repo">Repository</label>
                                        <input type="text" id="setting-github-repo" class="form-input" placeholder="owner/repo-name">
                                        <small class="form-hint">Format: owner/repository</small>
                                    </div>
                                </div>
                                <div class="form-row two-col">
                                    <div class="form-group">
                                        <label for="setting-github-branch">Branch</label>
                                        <input type="text" id="setting-github-branch" class="form-input" placeholder="main">
                                    </div>
                                    <div class="form-group">
                                        <label for="setting-github-token">Personal Access Token</label>
                                        <input type="password" id="setting-github-token" class="form-input" placeholder="ghp_xxxxxxxxxxxx">
                                        <small class="form-hint">Requires repo scope permissions</small>
                                    </div>
                                </div>
                                <div class="settings-actions">
                                    <button class="btn-action" onclick="testGitHubConnection()">Test Connection</button>
                                    <span id="github-connection-status" class="connection-status"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Data Operations -->
                        <div class="settings-section">
                            <div class="settings-section-header">
                                <h3>Data Operations</h3>
                            </div>
                            <div class="settings-section-body">
                                <div class="data-operations-grid">
                                    <!-- Re-parse Detections -->
                                    <div class="data-operation-card">
                                        <div class="data-operation-icon">&#x1F504;</div>
                                        <div class="data-operation-info">
                                            <h4>Re-parse All Detections</h4>
                                            <p>Re-analyze SPL and update metadata for all detections</p>
                                        </div>
                                        <button class="btn-action" onclick="reparseAllDetections()">Re-parse</button>
                                        <div id="reparse-progress" class="progress-indicator hidden">
                                            <div class="progress-bar"><div class="progress-fill" id="reparse-progress-fill"></div></div>
                                            <span class="progress-text" id="reparse-progress-text">0%</span>
                                        </div>
                                    </div>

                                    <!-- Import Detections -->
                                    <div class="data-operation-card">
                                        <div class="data-operation-icon">&#x1F4E5;</div>
                                        <div class="data-operation-info">
                                            <h4>Import Detections</h4>
                                            <p>Import detections from a JSON file</p>
                                        </div>
                                        <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                                        <button class="btn-action" onclick="document.getElementById('import-file-input').click()">Import JSON</button>
                                    </div>

                                    <!-- Export Detections -->
                                    <div class="data-operation-card">
                                        <div class="data-operation-icon">&#x1F4E4;</div>
                                        <div class="data-operation-info">
                                            <h4>Export Detections</h4>
                                            <p>Download all detections as a JSON file</p>
                                        </div>
                                        <button class="btn-action" onclick="exportAllDetections()">Export JSON</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Parsing Rules Configuration -->
                        <div class="settings-section">
                            <div class="settings-section-header">
                                <h3>Parsing Rules</h3>
                                <button class="btn-action btn-small" onclick="addParsingRule()">+ Add Rule</button>
                            </div>
                            <div class="settings-section-body">
                                <p class="settings-description">Configure custom parsing rules for extracting metadata from SPL queries.</p>
                                <div class="parsing-rules-table-container">
                                    <table class="parsing-rules-table">
                                        <thead>
                                            <tr>
                                                <th>Rule Name</th>
                                                <th>Pattern (Regex)</th>
                                                <th>Extract Field</th>
                                                <th>Enabled</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="parsing-rules-tbody">
                                            <!-- Parsing rules will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Splunk Configuration -->
                        <div class="settings-section">
                            <div class="settings-section-header">
                                <h3>Splunk Configuration</h3>
                            </div>
                            <div class="settings-section-body">
                                <div class="form-row two-col">
                                    <div class="form-group">
                                        <label for="setting-splunk-base-url">Splunk Base URL</label>
                                        <input type="text" id="setting-splunk-base-url" class="form-input" placeholder="https://myorg.splunkcloud.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="setting-splunk-correlation-path">Correlation Search Path</label>
                                        <input type="text" id="setting-splunk-correlation-path" class="form-input" placeholder="/en-US/app/SplunkEnterpriseSecuritySuite/correlation_search_edit">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Settings Button -->
                        <div class="settings-footer">
                            <button class="btn-action btn-primary" onclick="saveAllSettings()">Save All Settings</button>
                            <button class="btn-action" onclick="resetSettings()">Reset to Defaults</button>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Macro Modal -->
            <div id="modal-macro" class="modal hidden">
                <div class="modal-overlay" onclick="closeMacroModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="macro-modal-title">Macro Details</h3>
                        <button class="modal-close" onclick="closeMacroModal()">Ã—</button>
                    </div>
                    <div class="modal-body" id="macro-modal-content">
                        <!-- Content injected by JS -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeMacroModal()">Close</button>
                    </div>
                </div>
            </div>

            <!-- Metadata Modal -->
            <div id="modal-metadata" class="modal hidden">
                <div class="modal-overlay"></div>
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h3>Detection Metadata</h3>
                        <div class="modal-header-actions">
                            <div class="metadata-view-toggle">
                                <button class="toggle-btn active" data-view="formatted" onclick="switchMetadataView('formatted')">Formatted</button>
                                <button class="toggle-btn" data-view="json" onclick="switchMetadataView('json')">JSON</button>
                            </div>
                            <button class="modal-close" onclick="closeMetadataModal()">Ã—</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div id="metadata-detection-name" class="metadata-title"></div>
                        <div id="metadata-formatted" class="metadata-formatted"></div>
                        <div id="metadata-json" class="metadata-json hidden">
                            <pre id="metadata-json-content" class="json-display"></pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="copyMetadataJson()">Copy JSON</button>
                        <button class="btn-action" onclick="closeMetadataModal()">Close</button>
                    </div>
                </div>
            </div>

            <!-- Confirm Modal -->
            <div id="modal-confirm" class="modal hidden">
                <div class="modal-overlay"></div>
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h3>Confirm</h3>
                        <button class="modal-close" onclick="closeConfirmModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <p id="confirm-message">Are you sure?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeConfirmModal()">Cancel</button>
                        <button id="btn-confirm-yes" class="btn-action btn-danger" onclick="confirmDeleteDetection()">Confirm</button>
                    </div>
                </div>
            </div>

            <!-- Load Detection Modal -->
            <div id="modal-load" class="modal hidden">
                <div class="modal-overlay" onclick="closeLoadModal()"></div>
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h3>Load Detection</h3>
                        <button class="modal-close" onclick="closeLoadModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="load-search">
                            <input type="text" id="load-search-input" class="form-input" placeholder="Search detections..." oninput="filterLoadList()">
                        </div>
                        <div id="load-list" class="load-list">
                            <!-- Detection items will be populated here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeLoadModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Unsaved Changes Modal -->
            <div id="modal-unsaved" class="modal hidden">
                <div class="modal-overlay"></div>
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h3>Unsaved Changes</h3>
                        <button class="modal-close" onclick="closeUnsavedModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <p>You have unsaved changes. Do you want to save before leaving?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="discardChanges()">Discard</button>
                        <button class="btn-action btn-primary" onclick="saveAndContinue()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Clear Form Confirmation Modal -->
            <div id="modal-clear-confirm" class="modal hidden">
                <div class="modal-overlay" onclick="closeClearConfirmModal()"></div>
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h3>Clear Form</h3>
                        <button class="modal-close" onclick="closeClearConfirmModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <p>You have unsaved changes. Are you sure you want to clear all form fields?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeClearConfirmModal()">Cancel</button>
                        <button class="btn-action btn-danger" onclick="confirmClearForm()">Clear Form</button>
                    </div>
                </div>
            </div>

            <!-- Tune Modal -->
            <div id="modal-tune" class="modal hidden">
                <div class="modal-overlay" onclick="closeTuneModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ðŸ”§ Record Tuning</h3>
                        <button class="modal-close" onclick="closeTuneModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <p class="modal-detection-label">Detection: <strong id="tune-detection-name"></strong></p>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label>JIRA Issue <span class="required">*</span></label>
                                <div class="jira-input-wrapper">
                                    <span class="jira-prefix">MRDP-</span>
                                    <input type="text" id="tune-jira" maxlength="4" pattern="[0-9]{4}" placeholder="1234" class="form-input jira-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Analyst Name <span class="required">*</span></label>
                                <input type="text" id="tune-analyst" class="form-input" placeholder="Your name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>What was tuned? <span class="required">*</span></label>
                            <textarea id="tune-description" class="form-textarea" rows="3" placeholder="Describe the tuning changes..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <select id="tune-reason" class="form-select">
                                <option value="">Select...</option>
                                <option value="false_positives">Reduce False Positives</option>
                                <option value="performance">Performance Optimization</option>
                                <option value="coverage">Expand Coverage</option>
                                <option value="threshold">Adjust Threshold</option>
                                <option value="data_source">Data Source Change</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fields to Update</label>
                            <div class="fields-list" id="tune-fields-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeTuneModal()">Cancel</button>
                        <button class="btn-action btn-primary" onclick="submitTune()">Continue to Editor</button>
                    </div>
                </div>
            </div>

            <!-- Retrofit Modal -->
            <div id="modal-retrofit" class="modal hidden">
                <div class="modal-overlay" onclick="closeRetrofitModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>âš¡ Record Retrofit</h3>
                        <button class="modal-close" onclick="closeRetrofitModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <p class="modal-detection-label">Detection: <strong id="retrofit-detection-name"></strong></p>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label>JIRA Issue <span class="required">*</span></label>
                                <div class="jira-input-wrapper">
                                    <span class="jira-prefix">MRDP-</span>
                                    <input type="text" id="retrofit-jira" maxlength="4" pattern="[0-9]{4}" placeholder="1234" class="form-input jira-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Analyst Name <span class="required">*</span></label>
                                <input type="text" id="retrofit-analyst" class="form-input" placeholder="Your name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>What was retrofitted? <span class="required">*</span></label>
                            <textarea id="retrofit-description" class="form-textarea" rows="3" placeholder="Describe the retrofit changes..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="retrofit-type" class="form-select">
                                <option value="schema">Schema Update</option>
                                <option value="metadata">Metadata Addition</option>
                                <option value="mitre">MITRE Mapping</option>
                                <option value="drilldown">Drilldown Addition</option>
                                <option value="documentation">Documentation</option>
                                <option value="revalidation">Annual Revalidation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fields to Update</label>
                            <div class="fields-list" id="retrofit-fields-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeRetrofitModal()">Cancel</button>
                        <button class="btn-action btn-primary" onclick="submitRetrofit()">Continue to Editor</button>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Resource Modal -->
            <div id="modal-resource" class="modal hidden">
                <div class="modal-overlay" onclick="closeResourceModal()"></div>
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h3 id="resource-modal-title">Add Resource</h3>
                        <button class="modal-close" onclick="closeResourceModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <form id="resource-form">
                            <div class="form-group">
                                <label for="resource-name">Name <span class="required">*</span></label>
                                <input type="text" id="resource-name" class="form-input" placeholder="Resource name" required>
                            </div>
                            <div class="form-group">
                                <label for="resource-url">URL <span class="required">*</span></label>
                                <input type="url" id="resource-url" class="form-input" placeholder="https://..." required>
                            </div>
                            <div class="form-group">
                                <label for="resource-category">Category <span class="required">*</span></label>
                                <select id="resource-category" class="form-select" required>
                                    <option value="">Select Category</option>
                                    <option value="dashboard">Dashboard</option>
                                    <option value="external">External URL</option>
                                    <option value="internal">Internal URL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="resource-description">Description</label>
                                <textarea id="resource-description" class="form-textarea" rows="2" placeholder="Optional description"></textarea>
                            </div>
                            <input type="hidden" id="resource-edit-id" value="">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeResourceModal()">Cancel</button>
                        <button id="btn-resource-save" class="btn-action btn-primary" onclick="saveResource()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="modal-settings" class="modal hidden">
                <div class="modal-overlay" onclick="closeSettingsModal()"></div>
                <div class="modal-content modal-large settings-modal-content">
                    <div class="modal-header">
                        <h3>Settings</h3>
                        <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
                    </div>
                    <div class="modal-body settings-modal-body">
                        <!-- Settings Tabs -->
                        <div class="settings-tabs">
                            <button class="settings-tab active" data-settings-tab="github" onclick="switchSettingsTab('github')">GitHub</button>
                            <button class="settings-tab" data-settings-tab="data" onclick="switchSettingsTab('data')">Data</button>
                            <button class="settings-tab" data-settings-tab="parsing" onclick="switchSettingsTab('parsing')">Parsing</button>
                            <button class="settings-tab" data-settings-tab="splunk" onclick="switchSettingsTab('splunk')">Splunk</button>
                        </div>

                        <!-- GitHub Tab -->
                        <div id="settings-tab-github" class="settings-tab-content active">
                            <div class="form-group">
                                <label for="modal-github-base-url">GitHub Base URL</label>
                                <input type="text" id="modal-github-base-url" class="form-input" placeholder="https://api.github.com">
                                <small class="form-hint">Leave default for github.com, or enter enterprise URL</small>
                            </div>
                            <div class="form-group">
                                <label for="modal-github-repo">Repository</label>
                                <input type="text" id="modal-github-repo" class="form-input" placeholder="owner/repo-name">
                                <small class="form-hint">Format: owner/repository</small>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label for="modal-github-branch">Branch</label>
                                    <input type="text" id="modal-github-branch" class="form-input" placeholder="main">
                                </div>
                                <div class="form-group">
                                    <label for="modal-github-token">Personal Access Token</label>
                                    <input type="password" id="modal-github-token" class="form-input" placeholder="ghp_xxxxxxxxxxxx">
                                </div>
                            </div>
                            <div class="settings-actions">
                                <button class="btn-action" onclick="testGitHubConnection()">Test Connection</button>
                                <span id="modal-github-connection-status" class="connection-status"></span>
                            </div>
                        </div>

                        <!-- Data Tab -->
                        <div id="settings-tab-data" class="settings-tab-content">
                            <div class="data-operations-list">
                                <div class="data-operation-row">
                                    <div class="data-operation-info">
                                        <h4>Re-parse All Detections</h4>
                                        <p>Re-analyze SPL and update metadata for all detections</p>
                                    </div>
                                    <button class="btn-action" onclick="reparseAllDetections()">Re-parse</button>
                                </div>
                                <div id="modal-reparse-progress" class="progress-indicator hidden">
                                    <div class="progress-bar"><div class="progress-fill" id="modal-reparse-progress-fill"></div></div>
                                    <span class="progress-text" id="modal-reparse-progress-text">0%</span>
                                </div>
                                <div class="data-operation-row">
                                    <div class="data-operation-info">
                                        <h4>Import Detections</h4>
                                        <p>Import detections from a JSON file</p>
                                    </div>
                                    <input type="file" id="modal-import-file-input" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                                    <button class="btn-action" onclick="document.getElementById('modal-import-file-input').click()">Import JSON</button>
                                </div>
                                <div class="data-operation-row">
                                    <div class="data-operation-info">
                                        <h4>Export Detections</h4>
                                        <p>Download all detections as a JSON file</p>
                                    </div>
                                    <button class="btn-action" onclick="exportAllDetections()">Export JSON</button>
                                </div>
                            </div>
                        </div>

                        <!-- Parsing Tab -->
                        <div id="settings-tab-parsing" class="settings-tab-content">
                            <div class="parsing-rules-header">
                                <p>Configure custom parsing rules for extracting metadata from SPL queries.</p>
                                <button class="btn-action btn-small" onclick="addParsingRule()">+ Add Rule</button>
                            </div>
                            <div class="parsing-rules-table-container modal-table">
                                <table class="parsing-rules-table">
                                    <thead>
                                        <tr>
                                            <th>Rule Name</th>
                                            <th>Pattern</th>
                                            <th>Field</th>
                                            <th>On</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="modal-parsing-rules-tbody">
                                        <!-- Parsing rules will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Splunk Tab -->
                        <div id="settings-tab-splunk" class="settings-tab-content">
                            <div class="form-group">
                                <label for="modal-splunk-base-url">Splunk Base URL</label>
                                <input type="text" id="modal-splunk-base-url" class="form-input" placeholder="https://myorg.splunkcloud.com">
                            </div>
                            <div class="form-group">
                                <label for="modal-splunk-correlation-path">Correlation Search Path</label>
                                <input type="text" id="modal-splunk-correlation-path" class="form-input" placeholder="/en-US/app/SplunkEnterpriseSecuritySuite/correlation_search_edit">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeSettingsModal()">Cancel</button>
                        <button class="btn-action btn-primary" onclick="saveAllSettings(); closeSettingsModal();">Save Settings</button>
                    </div>
                </div>
            </div>

            <!-- Parsing Rule Edit Modal -->
            <div id="modal-parsing-rule" class="modal hidden">
                <div class="modal-overlay" onclick="closeParsingRuleModal()"></div>
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h3 id="parsing-rule-modal-title">Add Parsing Rule</h3>
                        <button class="modal-close" onclick="closeParsingRuleModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <form id="parsing-rule-form">
                            <div class="form-group">
                                <label for="parsing-rule-name">Rule Name <span class="required">*</span></label>
                                <input type="text" id="parsing-rule-name" class="form-input" placeholder="e.g., Extract Index">
                            </div>
                            <div class="form-group">
                                <label for="parsing-rule-pattern">Regex Pattern <span class="required">*</span></label>
                                <input type="text" id="parsing-rule-pattern" class="form-input code-input" placeholder="e.g., index=(\w+)">
                                <small class="form-hint">Use capture groups () to extract values</small>
                            </div>
                            <div class="form-group">
                                <label for="parsing-rule-field">Extract to Field <span class="required">*</span></label>
                                <input type="text" id="parsing-rule-field" class="form-input" placeholder="e.g., indexes">
                            </div>
                            <div class="form-group">
                                <label class="toggle-label inline">
                                    <input type="checkbox" id="parsing-rule-enabled" checked>
                                    <span>Enabled</span>
                                </label>
                            </div>
                            <input type="hidden" id="parsing-rule-edit-id" value="">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeParsingRuleModal()">Cancel</button>
                        <button class="btn-action btn-primary" onclick="saveParsingRule()">Save Rule</button>
                    </div>
                </div>
            </div>

            <!-- Delete Resource Confirmation Modal -->
            <div id="modal-delete-resource" class="modal hidden">
                <div class="modal-overlay" onclick="closeDeleteResourceModal()"></div>
                <div class="modal-content modal-small">
                    <div class="modal-header">
                        <h3>Delete Resource</h3>
                        <button class="modal-close" onclick="closeDeleteResourceModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <p id="delete-resource-message">Are you sure you want to delete this resource?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-action" onclick="closeDeleteResourceModal()">Cancel</button>
                        <button id="btn-confirm-delete-resource" class="btn-action btn-danger" onclick="confirmDeleteResource()">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <footer class="status-bar">
                <div class="status-left">
                    <span class="status-indicator status-disconnected"></span>
                    <span class="status-text">Disconnected</span>
                </div>
                <div class="status-right">
                    <span class="status-version">v1.0.0</span>
                </div>
            </footer>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
